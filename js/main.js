$(function(){var e={};e.lckey="";e.domain="http://music.163.com";e.loaded={list:false,listType:"hot",loadingMore:null,rank:false,radio:false,singer:false,singerKey:"",page:1,pageCount:20,songCount:1,userInfo:null,loadingTimer:null,uid:null,hasMore:true,playing:false};e.lyric=null;e.options=Settings.getObject("options")||{list:1,radio:1,rank:1,mine:1,lyric:1,notify:1,cover:"album"};if(!e.options.lyric){e.options.lyric=1}var a=new mainConnector;e.init=function(){chrome.cookies.get({url:e.domain,name:"__csrf"},function(a){if(a!=null){e.lckey=a.value}Settings.setValue("lckey",e.lckey)});e.loaded.userInfo=Settings.getObject("userInfo");a.name="163music";a.init();a.onMessage(function(a){switch(a.act){case"play":e.player.info();break;case"loading":e.loading();break;case"loaded":e.loading(true);break;case"timeupdate":if(!e.loaded.playing){e.loaded.playing=true;if($(".cd img").hasClass("pausing")){$(".cd img").removeClass("pausing")}if($(".cd .ctrl").hasClass("play")){$(".cd .ctrl").removeClass("play").addClass("pause")}}e.player.timing(a);break}});var i=e.options;if(i.rank==0){$("nav ul li").eq(1).hide()}if(i.radio==0){$("nav ul li").eq(2).hide()}if(i.mine==0){$("nav ul li").eq(3).hide()}e.bind();e.player.info();if(Settings.getObject("song")==undefined){$(".footer").trigger("click")}};e.nav=function(){e.nav.scroll(true)};e.nav.scroll=function(a){if(!a){$(".list").unbind("scroll")}else{$(".list").unbind("scroll");$(".list").bind("scroll",function(){var a=$(".list").scrollTop();if(!e.loaded.loadingMore){if(e.loaded.hasMore){if($(".list ul:visible").height()-a<300){e.loaded.page++;e.loaded.loadingMore=true;if(e.loaded.listType=="dj"){e.dj(e.loaded.page,e.loaded.pageCount,true)}else{e.list(e.loaded.listType,e.loaded.page,e.loaded.pageCount,true)}}}}})}};e.bind=function(){e.nav();$(".footer").bind("click",function(){$(".body").animate({top:0});$(this).hide();setTimeout(function(){$(".header").addClass("up");$("nav div input").show()},300);if(!e.loaded.list){e.list("hot",1,20)}});$(".arrow").bind("click",function(){$("nav div input").hide();$(".body").animate({top:"285px"});$("footer").show();$("header").removeClass("up")});$("nav ul li").bind("click",function(){var a=$(this);$("nav ul li").removeClass("hover");a.addClass("hover");var i=a.text();switch(i){case"分类":e.rank();e.nav.scroll(false);break;case"最热":e.list("hot",1,20);e.nav.scroll(true);break;case"最新":e.list("new",1,20);e.nav.scroll(true);break;case"DJ":e.dj(1,20);e.nav.scroll(true);break;case"收藏":e.user(true);e.nav.scroll(false);break;default:e.search();e.nav.scroll(false);break}});$(".search button").bind("click",function(){var a=$("#keyword").val();if(a!="")e.list("search",0,100,false,a)});$("nav input").bind("keydown",function(){if(event.keyCode==13){$("nav ul li").removeClass("hover");e.nav.scroll(false);var a=$(this).val();e.singer(a)}});$(".list").on("mouseover","li p",function(){var e=$(this);$("."+e.attr("class")).siblings(".loc").hide();$("."+e.attr("class")).siblings(".intro").hide();e.siblings(".loc").show();e.siblings(".intro").show()});$(".list").on("click","p a",function(){var a=$(this);e.player.playlist(a.attr("data-id"),a.attr("data-type"),a.attr("data-fav"));setTimeout(function(){$(".arrow").trigger("click")},200)});$(".rank").on("click","li a",function(){var a=$(this);e.list(a.text(),1,20);e.nav.scroll(true)});$(".cd .ctrl").bind("click",function(){var a=$(this);if(a.hasClass("pause")){e.player.pause()}else{e.player.play()}});$(".player").bind("mouseover",function(){$(".info").show();if(parseInt(Settings.getValue("index",0))>0){$(".prev").show()}if(e.loaded.songCount!=1){$(".next").show()}$("#favBtn").show()});$("#favBtn").bind("click",function(){e.fav()});$(".player").bind("mouseout",function(){$(".next,.prev,.info,#favBtn").hide()});$(".next").bind("click",function(){e.player.reset();e.player.next()});$(".prev").bind("click",function(){e.player.reset();e.player.prev()});if(Settings.getValue("cycle",0)==1){$(".cycle").addClass("cycle1")}$(".cycle").bind("click",function(){var e=$(this);e.toggleClass("cycle1");if(e.hasClass("cycle1")){Settings.setValue("cycle",1);e.attr("title","单曲循环")}else{Settings.setValue("cycle",0);e.attr("title","顺序播放")}});$(".cd img").bind("error",function(){$(this).attr("src","img/cover.png")});$(".list").on("click","a.fav",function(){e.subscribe($(this))});$(".list").on("click",".author",function(){var a=$(this);if(a.attr("data-uid")){e.loaded.uid=a.attr("data-uid");e.list("profile",1,40,false,e.loaded.uid)}});$(".author").bind("click",function(){var a=$(this);if(a.attr("data-uid")){e.loaded.uid=a.attr("data-uid");e.list("profile",1,40,false,e.loaded.uid);$(".body").animate({top:0});$(".footer").hide();setTimeout(function(){$(".header").addClass("up");$("nav div input").show()},300)}});$(".sider").bind("click",function(){$(".song").animate({marginLeft:"350"},200)});$(".list").on("click",".memo",function(){var a=$(this).data("id");var i={title:$(this).data("title"),author:$(this).data("author"),face:$(this).data("face"),type:$(this).data("type")};e.songlist(a,i)});$(".song").on("click",".s-play",function(){var a=$(this);e.player.playlist(a.data("id"),a.data("type"),0,a.data("index"));setTimeout(function(){$(".sider").trigger("click");setTimeout(function(){$(".arrow").trigger("click")},200)},500)});$(".lyric").click(function(){if($(this).data("link")){window.open($(this).data("link"))}})};e.player={reset:function(){},playlist:function(e,i,t,l){i="play"+i;var s={act:i,data:Settings.getCacheValue(e),fav:t,idx:l};a.send(s)},up:function(){a.send({act:"up"})},down:function(){a.send({act:"down"})},play:function(){$(".ctrl").addClass("pause").removeClass("play");$(".cd img").removeClass("pausing");a.send({act:"play"})},pause:function(){e.loaded.playing=true;a.send({act:"pause"});$(".ctrl").removeClass("pause").addClass("play");$(".cd img").addClass("pausing")},next:function(){a.send({act:"next"})},prev:function(){a.send({act:"prev"})},timing:function(a){var i=Math.ceil(a.time);var t=Math.ceil(a.duration-a.time);$(".timer").text(tool.formatTime(t));if(e.options&&e.options.lyric==1){if(e.lyric!=null&&e.lyric[i]!=undefined){$(".lyric").html(e.lyric[i])}}},info:function(){var a=Settings.getObject("song");if(a){if(a.isfaved){$("#favBtn").addClass("faved")}else{$("#favBtn").removeClass("faved")}$(".info,.lyric").html("&lt;"+a.name+"&gt;&nbsp;&nbsp;"+a.artists[0].name);if(e.options&&e.options.cover=="album"){$(".cd img").attr("src",a.album.picUrl)}else{$(".cd img").attr("src",a.artists[0].picUrl)}if(!a.lyric){e.getLyric(a)}else{e.lyric=a.lyric}$(".lyric").data("link","http://music.163.com/#/song?id="+a.id)}else{}var i=Settings.getObject("list");if(i){var t=i.coverUrl||i.coverImgUrl;$(".cover img").attr("src",t+"?param=60y60");$(".title h1").text(i.name);var l=i.dj||i.creator;$(".title h2 a").text(l.nickname);$(".face a img").attr("src",l.avatarUrl);$(".title h2 a").attr("data-uid",l.userId)}var s=Settings.getObject("songs");if(s)e.loaded.songCount=s.length}};e.list=function(a,i,t,l,s){l=l||false;if(e.loaded.list&&!l&&e.loaded.listType==a&&a!="profile"&&a!="search"){$(".list ul").hide();$(".list .collection").show();return}e.loading();var r=(new Date).getTime();var n="全部";n=encodeURIComponent(n);var o="";var c={};i=(i-1)*20;switch(a){case"user":var d=e.loaded.userInfo.userId;o=e.domain+"/api/user/playlist?uid="+d+"&wordwrap=7&offset="+i+"&total=true&limit="+t;break;case"profile":o=e.domain+"/api/user/playlist/?offset=0&limit=301&uid="+s;break;case"hot":o=e.domain+"/api/playlist/list?cat="+n+"&order="+a+"&offset="+i+"&total=true&limit="+t;break;case"new":o=e.domain+"/api/playlist/list?cat="+n+"&order="+a+"&offset="+i+"&total=true&limit="+t;break;case"search":o=e.domain+"/api/search/get/web?cmd=search";c.s=s;c.type=1e3;c.offset=0;c.limit=100;c.total="false";break;default:n=encodeURIComponent(a);o=e.domain+"/api/playlist/list?cat="+a+"&order=hot&offset="+i+"&total=true&limit="+t;break}o+="&csrf_token="+e.lckey;var u='<li>	<p class="p[i]"><a title="[name]" data-id="[id]" data-type="list" data-fav="[favst]"></a><img src="[cover]" /></p>	<i class="loc"></i>	<section class="intro">	<div class="face"><img src="[face]"/></div>	<div class="memo" title="点击查看歌单歌曲列表" data-type="list" data-id="[id]" data-title="[name]" data-author="[nick]" data-face="[face]">[desc]</div>	<div class="num">		<i class="author" title="点击查看用户所有歌单" data-uid="[creator]">[nick]</i><a title="[title]" class="fav[faved]" data-id="[id]">[fav]</a><a class="hits">[hits]</a>	</div>	</section>	</li>';var f="";var p=function(t){if(t.code==200){e.loaded.list=true;e.loaded.listType=a;e.loaded.loadingMore=false;var s=t.playlists;var r=t;if(a=="user"||a=="profile"){s=t.playlist;r=t}if(a=="search"){s=t.result.playlists;r=t}if(t.more){e.loaded.hasMore=true}else{e.loaded.hasMore=false}for(var n=0;n<s.length;n++){var o=s[n];Settings.setCacheValue(o.id,o);if(o.coverImgUrl==null||o.coverImgUrl==""){o.coverImgUrl="img/cover.png"}if(o.description==""||o.description==null){o.description=o.name}var c=u.replace("[cover]",o.coverImgUrl+"?param=60y60");var d=parseInt((n+4)/4)+5*(i-1);c=c.replace("[i]",d);if(o.creator.avatarUrl==undefined)c=c.replace(/\[face\]/g,"img/logo.png");else c=c.replace(/\[face\]/g,o.creator.avatarUrl);c=c.replace(/\[nick\]/g,o.creator.nickname);c=c.replace("[creator]",o.creator.userId);c=c.replace("[desc]",o.description);c=c.replace(/\[name\]/g,o.name);c=c.replace("[hits]",o.playCount);c=c.replace("[fav]",o.subscribedCount);c=c.replace(/\[id\]/g,o.id);if(a=="user"){c=c.replace("[faved]"," faved");c=c.replace("[title]"," 取消收藏");if(n==0){c=c.replace("[favst]","1")}else{c=c.replace("[favst]","0")}}else{c=c.replace("[favst]","0");c=c.replace("[faved]","");c=c.replace("[title]"," 收藏歌单")}f+=c}if(!l){$(".list ul").hide();$(".list .collection").html(f).show();$(".list").scrollTop(0)}else{$(".list .collection").append(f)}e.loading(true)}else{e.loaded.hasMore=false}};if(a!="search"){$.getJSON(o,function(e){p(e)})}else{$.post(o,c,function(e){var a=JSON.parse(e);p(a)})}};e.search=function(e){$(".list ul").hide();$(".list").scrollTop(0);$(".list .search").show()};e.dj=function(a,i,t){t=t||false;if(e.loaded.list&&!t&&e.loaded.listType=="dj"){$(".list ul").hide();$(".list .collection").show();return}e.loading();a=(a-1)*20;var l=e.domain+"/api/djprogram/list?type=hot&offset="+a+"&total=true&limit="+i;l+="&csrf_token="+e.lckey;var s='<li>	<p class="p[i]"><a title="[name]" data-id="[id]" data-type="dj"></a><img src="[cover]" /></p>	<i class="loc"></i>	<section class="intro">	<div class="face"><img src="[face]"/></div>	<div class="memo" data-type="dj" data-id="[id]" data-title="[name]" data-author="[nick]" data-face="[face]">[desc]</div>	<div class="num">		<i data-uid="[creator]">[nick]</i><a class="hits">[hits]</a>	</div>	</section>	</li>';var r="";$.getJSON(l,function(i){if(i.code==200){e.loaded.list=true;e.loaded.listType="dj";e.loaded.loadingMore=false;var l=i.result;if(i.more){e.loaded.hasMore=true}else{e.loaded.hasMore=false}for(var n=0;n<l.length;n++){var o=l[n];Settings.setCacheValue(o.id,o);if(o.coverUrl==null||o.coverUrl==""){o.coverUrl="img/cover.png"}if(o.description==""||o.description==null){o.description=o.name}var c=s.replace("[cover]",o.coverUrl+"?param=60y60");var d=parseInt((n+4)/4)+5*(a-1);c=c.replace("[i]",d);c=c.replace(/\[face\]/g,o.dj.avatarUrl);c=c.replace(/\[nick\]/g,o.dj.nickname);c=c.replace("[creator]",o.dj.userId);c=c.replace("[desc]",o.description);c=c.replace(/\[name\]/g,o.name);c=c.replace("[hits]",o.listenerCount);c=c.replace("[fav]",o.subscribedCount);c=c.replace(/\[id\]/g,o.id);r+=c}if(!t){$(".list ul").hide();$(".list .collection").html(r).show();$(".list").scrollTop(0)}else{$(".list .collection").append(r)}e.loading(true)}else{e.loaded.hasMore=false}})};e.rank=function(){$(".list ul").hide();$(".list").scrollTop(0);$(".list .rank").show();return};e.radio=function(){if(e.loaded.radio){$(".list ul").hide();$(".list .radio").show();return}e.loading();var a=(new Date).getTime();var i=e.domain+"/api/djprogram/list?type=new&offset=0&total=true&limit=20";i+="&csrf_token="+e.lckey;var t='<li>	<p class="p[i]"><a data-id="[id]" data-type="radio"></a><img src="[cover]" /></p>	<em>[name]</em></li>';var l="";$.get(i,function(a){a=$.parseJSON(a);if(a.code==200){e.loaded.radio=true;for(var i=0;i<a.result.length;i++){var s=a.result[i];Settings.setCacheValue(s.id,s);var r=s.coverUrl+"?param=60y60";var n=t.replace("[cover]",r);n=n.replace("[i]",parseInt((i+4)/4));n=n.replace("[name]",s.name);n=n.replace("[id]",s.id);l+=n}$(".list ul").hide();$(".list .radio").html(l).show();e.loading(true)}})};e.singer=function(a,i){if(i==undefined){if(e.loaded.singer&&e.loaded.singerKey==a){$(".list ul").hide();$(".list .singer").show();return}}e.loading();i=i||1;var t=(new Date).getTime();var l=e.domain+"/search-ajaxsearch-searchalbum?kw="+a+"&pi="+i+"&pz=100&_="+t+"&lckey="+e.lckey;var s='<li[class]>	<p class="p[i]"><a data-id="[id]" data-type="[type]" title="[title]"></a><img src="[cover]" /></p>	<em>[name]</em></li>';var r="";$.getJSON(l,function(i){if(i.dm_error==0){e.loaded.singer=true;e.loaded.singerKey=a;var t=0;for(t=0;t<i.artists.length;t++){var l=i.artists[t];Settings.setCacheValue(l.id,l);var n=l.portrait;if(n==null)n="img/cover.png";var o=s.replace("[cover]",n);o=o.replace("[i]",parseInt((t+4)/4));o=o.replace("[name]",l.name);o=o.replace("[title]",l.name+"歌手电台");o=o.replace("[id]",l.id);o=o.replace("[type]","singer");o=o.replace("[class]"," class='star'");r+=o}$(".list ul").hide();var c=0;for(c=0;c<i.albums.length;c++){var l=i.albums[c];Settings.setCacheValue(l.id,l);var n=l.cover;if(n==null)n="img/cover.png";var o=s.replace("[cover]",n);o=o.replace("[i]",parseInt((c+t+4)/4));o=o.replace("[name]",l.name);o=o.replace("[title]",l.name);o=o.replace("[id]",l.id);o=o.replace("[type]","album");o=o.replace("[class]","");r+=o}$(".list .singer").html(r).show();$(".list").scrollTop(0);e.loading(true)}})};e.getLyric=function(a){var i=a.id;$(".lyric").text("正在加载歌词");var t=e.domain+"/api/song/media?id="+i+"&version=0";t+="&csrf_token="+e.lckey;$.getJSON(t,function(i){if(i.code==200&&!i.nolyric){var t=i.lyric.split("\n");var l=/^((?:\[[\d.:]+?\])+?)([^\[\]]*)$/;var s={};for(var r=0,n=t.length;r<n;r+=1){var o=t[r].match(l);var c;if(o){c=o[1].slice(1,-1).split("][");for(var d=0,u=c.length,f;d<u;d+=1){f=c[d].split(":");s[Number(f[0])*60+Math.round(f[1])]=o[2]}}}a.lyric=s;Settings.setObject("song",a);e.lyric=s;$(".lyric").text(a.name)}});$(".lyric").html(a.name)};e.user=function(a,i){chrome.cookies.get({url:"http://music.163.com",name:"MUSIC_U"},function(t){if(t!=null){$(".login").fadeOut();var l="";$.get("http://music.163.com/user/home",function(i){var t=/var\sGUser={(.*)}/i;l="{"+i.match(t)[1]+"}";l=l.replace("userId",'"userId"');l=l.replace("nickname",'"nickname"');l=l.replace("avatarUrl",'"avatarUrl"');l=l.replace("userType",'"userType"');l=l.replace("birthday",'"birthday"');var s=$.parseJSON(l);Settings.setObject("userInfo",s);e.loaded.userInfo=s;if(a)e.list("user",1,100);chrome.cookies.get({url:e.domain,name:"__csrf"},function(a){if(a!=null){e.lckey=a.value}Settings.setValue("lckey",e.lckey)})})}else{if(i){e.loaded.userInfo=null}else{$(".login").fadeIn();$(".login .close").unbind("click");$(".login .close").bind("click",function(){$(".login").fadeOut()})}}})};e.subscribe=function(a){if(e.loaded.userInfo==null){e.user();return}e.loading();var i=a.attr("data-id");var t=e.domain+"/api/playlist/subscribe/?id="+i;if(a.hasClass("faved")){t=e.domain+"/api/playlist/unsubscribe?pid="+i+"&id="+i}t+="&csrf_token="+e.lckey;$.get(t,function(i){if(i.code==200){if(a.hasClass("faved")){e.loaded.list=false;e.showtip("取消收藏成功")}else{e.showtip("收藏成功")}a.toggleClass("faved");e.loading(true)}})};e.loading=function(a){if(a){$(".loading").fadeOut();clearTimeout(e.loaded.loadingTimer)}else{$(".loading").fadeIn()}};e.fav=function(){if(e.loaded.userInfo==null){e.user();return}var a="1";var i=Settings.getObject("song");var t="add";if($("#favBtn").hasClass("faved")){$("#favBtn").removeClass("faved");t="del";a="0";e.showtip("取消收藏成功")}else{$("#favBtn").addClass("faved");e.showtip("收藏成功")}var l=e.domain+"/api/user/playlist/?offset=0&limit=301&uid="+e.loaded.userInfo.userId;l+="&csrf_token="+e.lckey;$.getJSON(l,function(a){if(a.code==200){var l="";for(var s=0;s<a.playlist.length;s++){var r=a.playlist[s];if(!r.subscribed){l=r.id;break}}if(l!=""){var n=e.domain+"/api/playlist/manipulate/tracks";var o={pid:l,op:t,trackIds:"["+i.id+"]",csrf_token:e.lckey};$.post(n,o,function(e){})}}});var s=Settings.getObject("songs");for(var r=0;r<s.length;r++){s[r].isfaved=a;i.isfaved=a;Settings.setObject("song",i);Settings.setObject("songs",s)}};e.hotkey=function(){var a=null;var i=function(e){$(".tips").fadeIn().text(e);clearTimeout(a);a=setTimeout(function(){$(".tips").fadeOut()},1e3)};e.showtip=i;$("body").bind("keydown",function(){var a=window.event.keyCode;switch(a){case 39:e.player.reset();e.player.next();i("下一首");break;case 37:e.player.reset();e.player.prev();i("上一首");break;case 38:e.player.up();var t=Settings.getValue("volume",1)*100;i("音量"+t+"%");break;case 40:e.player.down();var t=Settings.getValue("volume",1)*100;i("音量"+t+"%");break;case 80:if($(".cd .ctrl").hasClass("play")){e.player.play();i("播放")}else{e.player.pause();i("暂停")}break}})};e.songlist=function(a,i){var t=e.domain+"/playlist?id="+a;if(i.type=="dj")t=e.domain+"/dj?id="+a;$(".s-title").text(i.title);$(".s-pic").attr("title",i.author);$(".s-pic img").attr("src",i.face);$(".s-list").html('<p style="margin-left: 98px;margin-top: 80px;"><img src="img/loading.gif"></p>');$(".song").animate({marginLeft:"0"},200);$.get(t,function(e){var t=/<table\sid="m-song-module"\sclass="m-table">([\s\S]*)<\/table>/;if(!t.test(e)){$(".s-list").html('<p style="text-align:center;margin-top: 80px;">无歌曲列表~</p>');return}var l=e.match(t)[1];var s=document.createElement("table");s.innerHTML=l;var r={ids:[],names:[],singers:[]};var n=$(s);n.find(".ztag").each(function(){r.ids.push($(this).data("id"))});n.find(".txt b a").each(function(){r.names.push($(this).text())});n.find(".text span").each(function(){r.singers.push($(this).text())});var o=[];for(var c=0;c<r.ids.length;c++){o.push('<li><span class="s-btn"><a class="s-play" data-index="'+c+'" data-type="'+i.type+'" data-id="'+a+'"></a><a class="s-index">'+(c+1)+'</a></span>				<a class="s-name" title="'+r.names[c]+'">'+r.names[c]+'</a><a class="s-singer" title="'+r.singers[c]+'">'+r.singers[c]+"</a></li>")}$(".s-list").html(o.join(""))})};e.init();e.hotkey();window.netease=e});